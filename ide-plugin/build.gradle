import groovy.xml.*

plugins {
    id 'java'
    id 'org.jetbrains.intellij' version '0.4.9'
    id 'org.jetbrains.kotlin.jvm' version '1.3.41'
}

group 'org.jetbrains.completion.full.line'
version '0.0.2'

sourceCompatibility = 1.8

repositories {
    mavenCentral()
    maven { url "https://www.jetbrains.com/intellij-repository/snapshots" }
}

dependencies {
    implementation "org.jetbrains.kotlin:kotlin-reflect:1.3.41"
    implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk8"

    testImplementation("org.junit.jupiter:junit-jupiter-params:5.4.2")
    testImplementation("org.junit.jupiter:junit-jupiter-api:5.4.2")
    testRuntime("org.junit.jupiter:junit-jupiter-engine:5.4.2")
}

compileKotlin {
    kotlinOptions.jvmTarget = "1.8"
}

compileTestKotlin {
    kotlinOptions.jvmTarget = "1.8"
}

patchPluginXml {
    sinceBuild '193'
    untilBuild '201.*'

    changeNotes """
        0.0.2 <br>
        <ul>
            <li>Create auto-generated root public.xml for downloading plugin</li>
            <li>Make plugin compatible with all intellij-based IDE's</li>
            <li>Move build since 193 until 201</li>
            <li>Publish plugin with TeamCity</li>
        </ul>
        0.0.1 <br>
        <ul>
            <li>Simple Full Line Code Completion with ML Server</li>
            <li>Completing full line with <code>Enter</code></li>
            <li>Completing only one token with <code>Tab</code></li>
        </ul>
        """
}

task copyPlugin(type: Copy) {
    from buildPlugin
    into rootDir
    rename { String fileName ->
        fileName.replace(fileName, gradle.ext.pluginName)
    }
}

task generatePublicXML {
    dependsOn(copyPlugin)
    doLast {
        file("plugin.xml").withWriter { writer ->
            def xml = new MarkupBuilder(new IndentPrinter(writer, "    ", true))

            xml.doubleQuotes = true
            xml.mkp.xmlDeclaration(version: '1.0', encoding: 'UTF-8')

            // Leave file comment
            xml.mkp.comment("AUTO-GENERATED FILE. DO NOT MODIFY. " +
                    "${gradle.ext.pluginName} is generated by the generatePublicXML gradle task")
            xml.mkp.yield('\n')

            //Generated plugin.xml data
            xml.plugins {
                plugin {
                    name("Full Line Code Completion")
                    id("org.jetbrains.completion.full.line")
                    xml.version(version)
                    'idea-version'("since-build": "193")
                    vendor('url': 'https://www.jetbrains.com', "JetBrains")
                    'download-url'(gradle.ext.pluginName)
                    xml.description {
                        mkp.yieldUnescaped('<![CDATA[\n' +
                                '           <p>A prototype for showing full line code completion variants in IntelliJ</p>\n' +
                                '    ]]>')
                    }
                    depends("com.intellij.modules.lang")
                    depends("com.intellij.modules.python")
                }
            }
        }
    }
}

intellij {
    version '193.4778.7-EAP-SNAPSHOT'
    plugins "PythonCore:193.4778.7", "sh", 'java'
}

runIde {
    jvmArgs '-Xmx1G'
}

test {
    useJUnitPlatform()
}
